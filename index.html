<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>

    <div class="topnav">
        <div class="search-container">
            <input id="citySearch" type="text" placeholder="Search for city...">
            <button onclick="searchLocation()">search</button>
        </div>
    </div>
    <p>Latitude: <output id="latitude"></output></p>
    <p>Longitude: <output id="longitude"></output></p>
    <p>County: <output id="county"></output></p>
    <div id="hourly-forecast"></div>

    <script>
        let dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        function fetchJsonThen(url, func) {
            fetch(url).then(
                function (response) {
                    return response.json();
                }
            ).then(
                function (data) {
                    return func(data);
                }
            ).catch(
                function (err) {
                    console.log('Fetch Error :-S', err);
                }
            );
        }
        function searchLocation() {
            var input,
            input = document.getElementById("citySearch");
            fetchJsonThen("https://nominatim.openstreetmap.org/search?format=geocodejson&featureType=city&addressdetails=1&q=" + input.value, handleGeocodeResponse)
        }
        function handleGeocodeResponse(data) {
            if(data.features.length < 1) {
                console.log("Failed to find any cities with that name.");
                return;
            }
            var top = data.features[0];
            console.log(top.properties.geocoding.name + ", " + top.properties.geocoding.state);
            console.log(top.geometry.coordinates[0] + ", " + top.geometry.coordinates[1]);
            handleGeoLocation(top.geometry.coordinates[1], top.geometry.coordinates[0])
        }
        function getGeoLocation() {
            navigator.geolocation.getCurrentPosition(function(position) {handleGeoLocation(position.coords.latitude, position.coords.longitude)});
        }
        function handleGeoLocation(latitude, longitude) {
            latitude = latitude.toFixed(4);
            longitude = longitude.toFixed(4);
            document.getElementById("latitude").innerHTML = latitude;
            document.getElementById("longitude").innerHTML = longitude;
            getLocationMetadata(latitude, longitude);
        }
        function getLocationMetadata(latitude, longitude) {
            fetchJsonThen(
                "https://api.weather.gov/points/" + latitude + "," + longitude,
                function (data) {
                    console.log(data)
                    fetchJsonThen(data.properties.forecastHourly, getHourlyForecast);
                    //fetchJsonThen(data.properties.forecast, getDailyForecast);
                    fetchJsonThen(data.properties.county, getLocationName);
                }
            )
        }
        function getHourlyForecast(data) {
            let tableText = "<table border=\"1\"><tr><td>Time</td><td>Icon</td><td>Temp</td><td>Rain%</td><td>Wind</td><td>Description</td></tr>";
            for (let period of data.properties.periods) {
                tableText += formatPeriod(period);
            }
            document.getElementById("hourly-forecast").innerHTML = tableText;
        }
        function formatPeriod(period) {
            let row = "<tr style=\"color:" + (period.isDaytime ? "black" : "grey") + "\">";
            let start = new Date(Date.parse(period.startTime));
            row += "<td>" + dayNames[start.getDay()] + " " + start.getHours() + "</td>";
            row += "<td><img src=\"" + period.icon + "\"></td>";
            row += "<td>" + period.temperature + " F</td>";
            row += "<td>" + period.probabilityOfPrecipitation.value + "%</td>";
            row += "<td>" + period.windSpeed + "</td>";
            row += "<td>" + period.shortForecast + "</td>";
            return row + "</tr>";
        }
        function getDailyForecast(data) {

        }
        function getLocationName(data) {
            document.getElementById("county").innerHTML = data.properties.name;
        }
        //getGeoLocation();
    </script>

</body>

</html>